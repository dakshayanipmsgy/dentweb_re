<?php
declare(strict_types=1);
require_once __DIR__ . '/includes/auth.php';
require_once __DIR__ . '/includes/employee_portal.php';
require_once __DIR__ . '/includes/employee_admin.php';
require_once __DIR__ . '/admin/includes/documents_helpers.php';
documents_ensure_structure();
$employeeStore = new EmployeeFsStore();
$user = current_user();
$viewerType='';$viewerId='';
if (is_array($user) && (($user['role_name'] ?? '') === 'admin')) { $viewerType='admin'; $viewerId=(string)($user['id'] ?? ''); }
else { $employee = employee_portal_current_employee($employeeStore); if ($employee !== null) { $viewerType='employee'; $viewerId=(string)($employee['id'] ?? ''); }}
if ($viewerType==='') { header('Location: login.php'); exit; }
$id=safe_text($_GET['id'] ?? ''); $quote=documents_get_quote($id); if($quote===null){http_response_code(404);exit('Quotation not found.');}
if($viewerType==='employee' && ((string)($quote['created_by_type'] ?? '')!=='employee' || (string)($quote['created_by_id'] ?? '')!==$viewerId)){http_response_code(403);exit('Access denied.');}
$redirect=static function(string $t,string $m) use ($id): void { header('Location: quotation-view.php?'.http_build_query(['id'=>$id,'status'=>$t,'message'=>$m])); exit; };
if($_SERVER['REQUEST_METHOD']==='POST'){
 if(!verify_csrf_token($_POST['csrf_token'] ?? null)){$redirect('error','Security validation failed.');}
 $action=safe_text($_POST['action'] ?? '');
 if($action==='approve_quote' && $viewerType==='admin'){ $quote['status']='Approved'; $quote['approval']['approved_by_name']=(string)($user['full_name'] ?? 'Admin'); $quote['approval']['approved_at']=date('c'); $quote['updated_at']=date('c'); documents_save_quote($quote); $redirect('success','Quotation approved.'); }
 if($action==='share_update'){ $quote['share']['public_enabled']=isset($_POST['public_enabled']); if(isset($_POST['generate_token']) || (string)($quote['share']['public_token'] ?? '')===''){ $quote['share']['public_token']=bin2hex(random_bytes(16)); } $quote['updated_at']=date('c'); documents_save_quote($quote); $redirect('success','Share settings updated.'); }
}
$shareUrl=((isset($_SERVER['HTTPS']) && $_SERVER['HTTPS']!=='off')?'https://':'http://').($_SERVER['HTTP_HOST'] ?? 'localhost').'/quotation-public.php?token='.urlencode((string)($quote['share']['public_token'] ?? ''));
$quoteDefaults = documents_get_quote_defaults_settings();
$company = documents_get_company_profile_for_quotes();
$segment = (string)($quote['segment'] ?? 'RES');
$segmentDefaults = is_array($quoteDefaults['segments'][$segment] ?? null) ? $quoteDefaults['segments'][$segment] : [];
$brand = $quoteDefaults['global']['branding'] ?? [];
$theme = ['primary'=>$brand['primary_color'] ?? '#0f766e','secondary'=>$brand['secondary_color'] ?? '#22c55e','accent'=>$brand['accent_color'] ?? '#f59e0b','header_bg'=>$brand['header_bg'] ?? '#0f766e','header_text'=>$brand['header_text'] ?? '#ecfeff','footer_bg'=>$brand['footer_bg'] ?? '#0f172a','footer_text'=>$brand['footer_text'] ?? '#e2e8f0','chip_bg'=>$brand['chip_bg'] ?? '#ccfbf1','chip_text'=>$brand['chip_text'] ?? '#134e4a'];
$preparedBy = (string)($quote['created_by_name'] ?? 'Team');
$snapshot = documents_quote_resolve_snapshot($quote);
$transport = (float)($quote['calc']['transportation_rs'] ?? $quote['finance_inputs']['transportation_rs'] ?? 0);
$subsidy = (float)($quote['calc']['subsidy_expected_rs'] ?? $quote['finance_inputs']['subsidy_expected_rs'] ?? 0);
if ($subsidy <= 0 && $segment === 'RES') { $cap=(float)($quote['capacity_kwp'] ?? 0); $subsidy = $cap>=3?(float)($segmentDefaults['subsidy']['cap_3kw_plus'] ?? 78000):($cap>=2?(float)($segmentDefaults['subsidy']['cap_2kw'] ?? 60000):0); }
$calc = documents_calc_pricing_from_items((array)($quote['items'] ?? []), (string)($quote['pricing_mode'] ?? 'solar_split_70_30'), (string)($quote['tax_type'] ?? 'CGST_SGST'), $transport, $subsidy, (float)($quote['input_total_gst_inclusive'] ?? 0));
$ann = is_array($quote['annexures_overrides'] ?? null) ? $quote['annexures_overrides'] : [];
$coverNote = trim((string)($quote['cover_note_text'] ?? '')) ?: trim((string)($quoteDefaults['defaults']['cover_note_template'] ?? ''));
$specialReq = trim((string)($quote['special_requests_text'] ?? $quote['special_requests_inclusive'] ?? ''));
?>
<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Quotation</title><style><?php $t=$quoteDefaults['global']['theme']??[]; $shadowMap=['none'=>'none','soft'=>'0 6px 18px rgba(15,23,42,0.08)','medium'=>'0 10px 24px rgba(15,23,42,0.12)','strong'=>'0 14px 28px rgba(15,23,42,0.18)']; $headerBg=!empty($t['header_gradient_enabled'])?'linear-gradient(135deg,'.($t['header_gradient_from']??'#0f766e').','.($t['header_gradient_to']??'#22c55e').')':($theme['header_bg']??'#0f766e'); $footerBg=!empty($t['footer_gradient_enabled'])?'linear-gradient(135deg,'.($t['footer_gradient_from']??'#0f172a').','.($t['footer_gradient_to']??'#1e293b').')':($theme['footer_bg']??'#0f172a'); ?>:root{--primary:<?= htmlspecialchars((string)($t['primary_color'] ?? $theme['primary'])) ?>;--accent:<?= htmlspecialchars((string)($t['accent_color'] ?? $theme['accent'])) ?>;--text:<?= htmlspecialchars((string)($t['text_color'] ?? '#0f172a')) ?>;--muted:<?= htmlspecialchars((string)($t['muted_text_color'] ?? '#475569')) ?>;--bg:<?= htmlspecialchars((string)($t['background_color'] ?? '#eef3f9')) ?>;--card-bg:<?= htmlspecialchars((string)($t['card_background_color'] ?? '#fff')) ?>;--border:<?= htmlspecialchars((string)($t['border_color'] ?? '#dbe1ea')) ?>;--shadow:<?= htmlspecialchars((string)($shadowMap[$t['shadow_strength'] ?? 'soft'] ?? $shadowMap['soft'])) ?>;--radius:<?= (int)($t['border_radius_px'] ?? 14) ?>px;--base-font:<?= (int)($t['base_font_px'] ?? 14) ?>px;--h1:<?= (int)($t['h1_px'] ?? 24) ?>px;--h2:<?= (int)($t['h2_px'] ?? 18) ?>px;--h3:<?= (int)($t['h3_px'] ?? 15) ?>px;--line-h:<?= (float)($t['line_height'] ?? 1.5) ?>;--header-bg:<?= htmlspecialchars($headerBg) ?>;--footer-bg:<?= htmlspecialchars($footerBg) ?>;}body{font-family:Inter,Arial,sans-serif;background:var(--bg);margin:0;color:var(--text);font-size:var(--base-font);line-height:var(--line-h)}.wrap{max-width:1100px;margin:0 auto;padding:12px}.card{background:var(--card-bg);border:1px solid var(--border);border-radius:var(--radius);padding:14px;margin-bottom:12px;box-shadow:var(--shadow)}.h{font-weight:700}.sec{border-bottom:2px solid var(--primary);padding-bottom:5px;margin-bottom:8px}.grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}.metric{background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:8px}.chip{background:<?= htmlspecialchars($theme['chip_bg']) ?>;color:<?= htmlspecialchars($theme['chip_text']) ?>;border-radius:99px;padding:4px 8px;font-size:12px;display:inline-block;margin:2px}.tbl{width:100%;border-collapse:collapse}.tbl th,.tbl td{border:1px solid var(--border);padding:6px;font-size:12px}.footer{background:var(--footer-bg);color:<?= htmlspecialchars($theme['footer_text']) ?>}@media(max-width:800px){.grid2{grid-template-columns:1fr}}</style></head><body><main class="wrap">
<!-- same sections as public -->
<section class="card" style="background:var(--header-bg);color:<?= htmlspecialchars($theme['header_text']) ?>"><div class="h">Dakshayani Enterprises</div><div><?= htmlspecialchars((string)($company['address_line'] ?? '')) ?>, <?= htmlspecialchars((string)($company['city'] ?? '')) ?></div><div>â˜ <?= htmlspecialchars((string)($company['phone_primary'] ?? '')) ?> <?= htmlspecialchars((string)($company['phone_secondary'] ?? '')) ?> Â· âœ‰ <?= htmlspecialchars((string)($company['email_primary'] ?? '')) ?> Â· ğŸŒ <?= htmlspecialchars((string)($company['website'] ?? '')) ?></div><div>GSTIN <?= htmlspecialchars((string)($company['gstin'] ?? '')) ?> Â· Udyam <?= htmlspecialchars((string)($company['udyam'] ?? '')) ?> Â· Licenses <?= htmlspecialchars((string)($company['jreda_license'] ?? '')) ?></div><div>Quote No <b><?= htmlspecialchars((string)$quote['quote_no']) ?></b> Â· Date <?= htmlspecialchars(substr((string)($quote['created_at'] ?? ''),0,10)) ?> Â· Valid till <?= htmlspecialchars((string)($quote['valid_until'] ?: '-')) ?> Â· Prepared by <?= htmlspecialchars($preparedBy) ?></div></section>
<section class="card"><div class="h sec">Customer Details</div><div class="grid2"><?php foreach(['Name'=>$snapshot['name'] ?? $quote['customer_name'],'Mobile'=>$snapshot['mobile'] ?? $quote['customer_mobile'],'Site Address'=>$quote['site_address'] ?? $snapshot['address'],'City'=>$snapshot['city'] ?? $quote['city'],'District'=>$snapshot['district'] ?? $quote['district'],'PIN'=>$snapshot['pin_code'] ?? $quote['pin'],'State'=>$snapshot['state'] ?? $quote['state'],'Consumer Account No (JBVNL)'=>$snapshot['consumer_account_no'] ?? $quote['consumer_account_no'],'Meter no'=>$snapshot['meter_number'] ?? $quote['meter_number'],'Meter serial'=>$snapshot['meter_serial_number'] ?? $quote['meter_serial_number'],'Application ID'=>$snapshot['application_id'] ?? $quote['application_id'],'Application submitted date'=>$snapshot['application_submitted_date'] ?? $quote['application_submitted_date'],'Circle'=>$snapshot['circle_name'] ?? $quote['circle_name'],'Division'=>$snapshot['division_name'] ?? $quote['division_name'],'Sub Division'=>$snapshot['sub_division_name'] ?? $quote['sub_division_name'],'Sanction load'=>$snapshot['sanction_load_kwp'] ?? $quote['sanction_load_kwp'],'Installed capacity'=>$snapshot['installed_pv_module_capacity_kwp'] ?? $quote['installed_pv_module_capacity_kwp']] as $k=>$v): if(trim((string)$v)==='') continue; ?><div><b><?= htmlspecialchars($k) ?>:</b> <?= htmlspecialchars((string)$v) ?></div><?php endforeach; ?></div></section>
<?php if($coverNote!==''): ?><section class="card">ğŸŒ <?= nl2br(htmlspecialchars($coverNote)) ?></section><?php endif; ?>
<section class="card"><div class="h sec">Items Table</div><table class="tbl"><thead><tr><th>Sr no</th><th>Item name</th><th>Description/specs</th><th>HSN</th><th>Qty</th><th>Unit</th></tr></thead><tbody><?php foreach(($quote['items'] ?? []) as $i=>$it): ?><tr><td><?= $i+1 ?></td><td><?= htmlspecialchars((string)($it['name'] ?? '')) ?></td><td><?= htmlspecialchars((string)($it['description'] ?? '')) ?></td><td><?= htmlspecialchars((string)($it['hsn'] ?? '')) ?></td><td><?= htmlspecialchars((string)($it['qty'] ?? '')) ?></td><td><?= htmlspecialchars((string)($it['unit'] ?? '')) ?></td></tr><?php endforeach; ?></tbody></table></section>
<section class="card"><div class="h sec">Pricing Summary</div><div class="grid2"><div class="metric">Basic price: <b>â‚¹<?= number_format((float)$calc['basic_total'],2) ?></b></div><div class="metric">GST @ 5% (on 70%): <b>â‚¹<?= number_format((float)$calc['bucket_5_gst'],2) ?></b></div><div class="metric">GST @ 18% (on 30%): <b>â‚¹<?= number_format((float)$calc['bucket_18_gst'],2) ?></b></div><div class="metric">Total system price (including GST): <b>â‚¹<?= number_format((float)$calc['final_price_incl_gst'],2) ?></b></div><div class="metric">Transportation: <b>â‚¹<?= number_format((float)$calc['transportation_rs'],2) ?></b></div><div class="metric">Gross payable (including GST): <b>â‚¹<?= number_format((float)$calc['gross_payable'],2) ?></b></div><div class="metric">Subsidy: <b>â‚¹<?= number_format((float)$calc['subsidy_expected_rs'],2) ?></b></div><div class="metric">Net after subsidy: <b>â‚¹<?= number_format((float)$calc['net_after_subsidy'],2) ?></b></div></div><div class="metric">70/30 GST rule applied for solar system back-calculation.</div><p>PM Surya Ghar: customer pays full amount; subsidy credited later after commissioning (as per scheme).</p></section>
<section class="card"><div class="h sec">Finance Clarity</div><div class="grid2"><div class="metric">Bank Loan Snapshot<br>1. Margin money: <b id="margin"></b><br>2. Initial loan amount: <b id="loan"></b><br>3. Loan amount after discounting subsidy (effective principal): <b id="loanEff"></b><br>4. EMI on discounted loan amount: <b id="emi"></b><br>5. Residual bill: <b id="residual"></b><br>6. Total monthly outflow (EMI + residual bill): <b id="outflow"></b></div><div class="metric">Self Financed Snapshot<br>1. Upfront investment (Gross payable): <b id="upfront"></b><br>2. Investment minus subsidy: <b id="upfrontNet"></b><br>3. Residual bill: <b id="selfResidual"></b></div><div class="metric">No Solar Snapshot<br><b id="noSolar"></b></div></div><p>For loans above â‚¹2L up to â‚¹6L: interest ~8.15%+ and margin ~20% (varies).</p></section>
<section class="card"><div class="h sec">Charts & Graphics</div><canvas id="c1" width="900" height="220"></canvas><canvas id="c2" width="900" height="220"></canvas><div id="payback"></div></section>
<section class="card"><div class="h sec">Environmental Impact</div><div class="grid2"><div class="metric">ğŸŒ¿ CO2 saved / year: <b id="co2y"></b></div><div class="metric">ğŸŒ³ Trees planted / year: <b id="treey"></b></div><div class="metric">â™»ï¸ CO2 saved / 25 years: <b id="co225"></b></div><div class="metric">ğŸŒ² Trees planted / 25 years: <b id="tree25"></b></div></div></section>
<?php if($specialReq!==''): ?><section class="card"><div class="h sec">Special Requests From Consumer (Inclusive in the rate)</div><div><?= nl2br(htmlspecialchars($specialReq)) ?></div><div><i>In case of conflict between annexures and special requests, special requests will be prioritized.</i></div></section><?php endif; ?>
<section class="card"><div class="h sec">Annexures</div><button type="button" id="toggleAnnexures">Collapse all</button><?php foreach(['warranty'=>'Warranty','system_inclusions'=>'System inclusions','pm_subsidy_info'=>'PM subsidy info','completion_milestones'=>'Completion milestones','payment_terms'=>'Payment terms','system_type_explainer'=>'System Type explainer (ongrid vs hybrid vs offgrid)','transportation'=>'Transportation','terms_conditions'=>'Terms and conditions'] as $k=>$label): ?><details open><summary><?= htmlspecialchars($label) ?></summary><div><?= nl2br(htmlspecialchars((string)($ann[$k] ?? ''))) ?></div></details><?php endforeach; ?></section>
<section class="card"><div class="h sec">Next Steps</div><?php foreach(['Confirm quotation','Book survey','Sign agreement','Install & net meter','Subsidy processing'] as $s): ?><span class="chip"><?= htmlspecialchars($s) ?></span><?php endforeach; ?></section>
<section class="card footer"><div class="h">Dakshayani Enterprises</div><div><?= htmlspecialchars((string)($company['address_line'] ?? '')) ?> Â· <?= htmlspecialchars((string)($company['phone_primary'] ?? '')) ?> Â· <?= htmlspecialchars((string)($company['email_primary'] ?? '')) ?> Â· <?= htmlspecialchars((string)($company['website'] ?? '')) ?></div></section>
<div class="card"><div class="h">Admin Actions</div><?php if($viewerType==='admin'): ?><form method="post" style="display:inline"><input type="hidden" name="csrf_token" value="<?= htmlspecialchars((string)($_SESSION['csrf_token'] ?? '')) ?>"><input type="hidden" name="action" value="approve_quote"><button>Approve</button></form><?php endif; ?><form method="post" style="display:inline;margin-left:8px"><input type="hidden" name="csrf_token" value="<?= htmlspecialchars((string)($_SESSION['csrf_token'] ?? '')) ?>"><input type="hidden" name="action" value="share_update"><label><input type="checkbox" name="public_enabled" <?= !empty($quote['share']['public_enabled'])?'checked':'' ?>> Public share</label><button name="generate_token" value="1">Generate token</button></form><div><?= htmlspecialchars($shareUrl) ?></div></div></main><script>const q={gross:<?= json_encode((float)$calc['gross_payable']) ?>,subsidy:<?= json_encode((float)$calc['subsidy_expected_rs']) ?>,monthly:<?= json_encode((float)($quote['finance_inputs']['monthly_bill_rs'] ?? 0)) ?>,unit:<?= json_encode((float)($quote['finance_inputs']['unit_rate_rs_per_kwh'] ?: $segmentDefaults['unit_rate_rs_per_kwh'] ?? 8)) ?>,cap:<?= json_encode((float)($quote['capacity_kwp'] ?? 0)) ?>,gen:<?= json_encode((float)($quote['finance_inputs']['annual_generation_per_kw'] ?: $segmentDefaults['annual_generation_per_kw'] ?? $quoteDefaults['global']['energy_defaults']['annual_generation_per_kw'] ?? 1450)) ?>};const r=x=>'â‚¹'+Number(x).toLocaleString('en-IN',{maximumFractionDigits:0});const minMargin=q.gross*0.10,loan=Math.min(q.gross-minMargin,200000),margin=q.gross-loan,loanEff=Math.max(0,loan-q.subsidy),rr=0.06/12,n=120,emi=loanEff>0?(loanEff*rr*Math.pow(1+rr,n))/((Math.pow(1+rr,n))-1):0,mUnits=q.monthly/Math.max(0.1,q.unit),solar=(q.cap*q.gen)/12,res=Math.max(0,mUnits-solar)*q.unit,out=emi+res;document.getElementById('margin').textContent=r(margin);document.getElementById('loan').textContent=r(loan);document.getElementById('loanEff').textContent=r(loanEff);document.getElementById('emi').textContent=r(emi);document.getElementById('residual').textContent=r(res);document.getElementById('outflow').textContent=r(out);document.getElementById('upfront').textContent=r(q.gross);document.getElementById('upfrontNet').textContent=r(q.gross-q.subsidy);document.getElementById('selfResidual').textContent=r(res);document.getElementById('noSolar').textContent='Monthly bill: '+r(q.monthly);function bars(){const c=document.getElementById('c1').getContext('2d'),v=[q.monthly,out,res],cl=['#ef4444','#2563eb','#16a34a'];c.clearRect(0,0,900,220);const m=Math.max(...v,1);v.forEach((x,i)=>{c.fillStyle=cl[i];c.fillRect(40+i*250,180-(x/m*140),80,x/m*140);});}bars();function lines(){const c=document.getElementById('c2').getContext('2d');c.clearRect(0,0,900,220);const pts=[];for(let y=0;y<=10;y++){pts.push([y,q.monthly*y*12,out*y*12,q.gross+res*y*12]);}const m=Math.max(...pts.map(p=>Math.max(p[1],p[2],p[3])));[['#ef4444',1],['#2563eb',2],['#16a34a',3]].forEach(a=>{c.strokeStyle=a[0];c.beginPath();pts.forEach((p,i)=>{const x=40+p[0]*80,yy=190-(p[a[1]]/m*150);if(i===0)c.moveTo(x,yy);else c.lineTo(x,yy)});c.stroke();});}lines();const sav=(q.monthly-res)*12;document.getElementById('payback').textContent='Payback meter: ~'+(q.gross/Math.max(1,sav)).toFixed(1)+' years';const ef=<?= json_encode((float)($quoteDefaults['global']['calculation_defaults']['emission_factor_kg_per_kwh'] ?? $quoteDefaults['global']['energy_defaults']['emission_factor_kg_per_kwh'] ?? 0.82)) ?>,treeRate=<?= json_encode((float)($quoteDefaults['global']['calculation_defaults']['tree_absorption_kg_per_tree_per_year'] ?? $quoteDefaults['global']['energy_defaults']['tree_absorption_kg_per_tree_per_year'] ?? 20)) ?>;const yearly=q.cap*q.gen,co2=yearly*ef,tree=co2/Math.max(0.01,treeRate);document.getElementById('co2y').textContent=co2.toFixed(0)+' kg';document.getElementById('treey').textContent=tree.toFixed(1);document.getElementById('co225').textContent=(co2*25).toFixed(0)+' kg';document.getElementById('tree25').textContent=(tree*25).toFixed(1);document.addEventListener('click',function(e){if(e.target&&e.target.id==='toggleAnnexures'){const section=e.target.closest('section.card');const d=section?section.querySelectorAll('details'):[];const close=e.target.dataset.state!=='closed';d.forEach(el=>{el.open=!close});e.target.dataset.state=close?'closed':'open';e.target.textContent=close?'Expand all':'Collapse all';}});</script></body></html>
